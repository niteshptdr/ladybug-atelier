{% extends "base.html" %}
{% block content %}


{% if messages %}
  <div class="space-y-2">
    {% for message in messages %}
      <div class="px-4 py-2 rounded-md 
                  {% if message.tags == 'success' %} bg-emerald-100 text-emerald-800 
                  {% elif message.tags == 'error' %} bg-red-100 text-red-700 
                  {% else %} bg-gray-100 text-gray-800 {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}


<div class="max-w-4xl mx-auto p-6 space-y-6">

  <!-- Lookup strip -->
<div class="bg-white rounded-lg shadow p-4">
  <label for="lookup_mobile" class="block text-sm font-medium text-gray-700 mb-2">
    Customer Mobile (10 digits)
  </label>
  <div class="flex gap-3">
    <input id="lookup_mobile" type="text"
           class="flex-1"
           placeholder="e.g. 9876543210" maxlength="10" inputmode="numeric" />
    <button id="btnLookup" type="button"
            class="rounded-lg bg-gray-900 text-white px-4 py-2 hover:bg-black">
      Check
    </button>
  </div>

  <div id="lookup_result" class="mt-3 hidden">
    <!-- Single status line instead of two badges -->
    <div id="status_line" class="text-sm hidden">
      <span id="status_text" class="font-medium text-gray-800"></span>
    </div>

    <div id="summary" class="mt-2 text-sm text-gray-700 hidden">
      <div><span class="font-medium">Name:</span> <span id="s_name">—</span></div>
      <div><span class="font-medium">Email:</span> <span id="s_email">—</span></div>
      <div><span class="font-medium">Orders placed:</span> <span id="s_orders">0</span></div>
    </div>
  </div>
</div>

  <!-- Form -->
  <form method="post" class="space-y-6">
    {% csrf_token %}

    <!-- Customer -->
    <div class="bg-white p-4 rounded-lg shadow space-y-4">
      <h2 class="text-lg font-semibold">Customer</h2>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>{{ cust_form.name.label_tag }} {{ cust_form.name }}</div>
        <div>{{ cust_form.mobile.label_tag }} {{ cust_form.mobile }}</div>
        <div>{{ cust_form.email.label_tag }} {{ cust_form.email }}</div>
      </div>


      <div class="grid grid-cols-3 sm:grid-cols-3 gap-1 text-xs">
        <div>{{ cust_form.building.label_tag }} {{ cust_form.building }}</div>
        <div>{{ cust_form.house.label_tag }} {{ cust_form.house }}</div>
        <div>{{ cust_form.street.label_tag }} {{ cust_form.street }}</div>
        <div>{{ cust_form.area.label_tag }} {{ cust_form.area }}</div>
        <div>{{ cust_form.city.label_tag }} {{ cust_form.city }}</div>
        <div>{{ cust_form.state.label_tag }} {{ cust_form.state }}</div>
        <div>{{ cust_form.zip_code.label_tag }} {{ cust_form.zip_code }}</div>
        <div>{{ cust_form.mobile_override.label_tag }} {{ cust_form.mobile_override }}</div>
      </div>
    </div>

    <!-- Items -->
<div class="bg-white p-4 rounded-lg shadow space-y-4">
  <h2 class="text-lg font-semibold">Items</h2>
  {{ formset.management_form }}

  {% for form in formset %}
    <div class="border rounded-lg p-4 space-y-4">

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>{{ form.mode.label_tag }} {{ form.mode }}</div>
        <div>{{ form.quantity.label_tag }} {{ form.quantity }}</div>
        <div>{{ form.product.label_tag }} {{ form.product }}</div>
        <div>{{ form.pattern.label_tag }} {{ form.pattern }}</div>
        <div>{{ form.fabric.label_tag }} {{ form.fabric }}</div>
        <div>{{ form.custom_pattern_name.label_tag }} {{ form.custom_pattern_name }}</div>
        <div>{{ form.custom_price.label_tag }} {{ form.custom_price }}</div>
      </div>

      <div>
        {{ form.custom_style_notes.label_tag }}
        {{ form.custom_style_notes }}
      </div>

      <!-- Measurements -->
      <div>
        <h3 class="text-md font-semibold mb-2">Measurements</h3>

        <!-- previous measurements (running text) shown here, not at top -->
        <div id="prev_meas_line" class="text-sm text-gray-700 mb-2 hidden"></div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {% for mf in measurement_fields %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">{{ mf.name }}</label>
              <input name="measurement_{{ mf.id }}" type="text"
                     data-meas="{{ mf.name }}"
                     placeholder="{{ mf.description }}" />
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Options -->
      <div>
        <h3 class="text-md font-semibold mb-2">Options</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {% for opt in pattern_options %}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">{{ opt.name }}</label>

              {% if opt.field_type == "bool" %}
                <input name="option_{{ opt.id }}" type="checkbox" />

              {% elif opt.field_type == "choice" and opt.choice_list %}
                <select name="option_{{ opt.id }}">
                  <option value="">-- Select --</option>
                  {% for c in opt.choice_list %}
                    <option value="{{ c }}">{{ c }}</option>
                  {% endfor %}
                </select>

              {% elif opt.field_type == "float" %}
                <input name="option_{{ opt.id }}" type="number" step="0.01" />

              {% else %}
                <input name="option_{{ opt.id }}" type="text" placeholder="{{ opt.description }}" />
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- JSON textareas removed -->
    </div>
  {% endfor %}
</div>

    <button type="submit" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black">
      Create Order
    </button>
  </form>
</div>

<script>
  // helper
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');
  const $ = (sel) => document.querySelector(sel);

  // Apply thin Tailwind border to every input/select/textarea (no widget filters needed)
  function styleAllFields(scope=document) {
    const cls = "w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-gray-900";
    scope.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea, select')
      .forEach(el => {
        // keep checkboxes small; only add ring/border to text-ish inputs & selects
        if (el.type !== 'checkbox') {
          el.className = (el.className ? el.className + ' ' : '') + cls;
        } else {
          el.className = (el.className ? el.className + ' ' : '') + "h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900";
        }
      });
  }
  styleAllFields();

  const lookupBtn = $('#btnLookup');
  lookupBtn.addEventListener('click', async () => {
    const mobile = $('#lookup_mobile').value.trim();

    const res = await fetch("{% url 'lookup-customer' %}", {
      method: "POST",
      headers: {"X-CSRFToken": csrftoken},
      body: new URLSearchParams({mobile})
    });

    $('#lookup_result').classList.remove('hidden');
    $('#summary').classList.add('hidden');
    $('#status_line').classList.add('hidden');

    if (!res.ok) {
      $('#status_line').classList.remove('hidden');
      $('#status_text').textContent = "Lookup failed. Please check mobile number.";
      return;
    }

    const data = await res.json();
    if (!data.ok) {
      $('#status_line').classList.remove('hidden');
      $('#status_text').textContent = data.error || "Lookup failed.";
      return;
    }

    const nameInput   = document.getElementById('id_name');
    const mobileInput = document.getElementById('id_mobile');
    const emailInput  = document.getElementById('id_email');
    const building    = document.getElementById('id_building');
    const house       = document.getElementById('id_house');
    const street      = document.getElementById('id_street');
    const area        = document.getElementById('id_area');
    const city        = document.getElementById('id_city');
    const state       = document.getElementById('id_state');
    const zip_code    = document.getElementById('id_zip_code');
    const mobileOver  = document.getElementById('id_mobile_override');

    // Show status line (single source of truth)
    $('#status_line').classList.remove('hidden');
    if (data.exists) {
      const p = data.profile || {};
      $('#status_text').textContent = "Customer found";

      $('#summary').classList.remove('hidden');
      $('#s_name').textContent = p.name || '—';
      $('#s_email').textContent = p.email || '—';
      $('#s_orders').textContent = data.orders_count ?? 0;

      nameInput && (nameInput.value = p.name || '');
      mobileInput && (mobileInput.value = p.mobile || '');
      emailInput && (emailInput.value = p.email || '');
      building && (building.value = p.building || '');
      house && (house.value = p.house || '');
      street && (street.value = p.street || '');
      area && (area.value = p.area || '');
      city && (city.value = p.city || '');
      state && (state.value = p.state || '');
      zip_code && (zip_code.value = p.zip_code || '');
      mobileOver && (mobileOver.value = p.mobile || '');

      // Prefill measurement inputs and show running text inside the item card
      const lastMeas = data.last_measurements || {};
      const keys = Object.keys(lastMeas);
      const line = keys.map(k => `${k}: ${lastMeas[k]}`).join(', ');

      const localPrev = document.getElementById('prev_meas_line');
      if (localPrev && line) {
        localPrev.classList.remove('hidden');
        localPrev.textContent = line;
      }

      const measInputs = document.querySelectorAll('input[data-meas]');
      measInputs.forEach(inp => {
        const labelName = inp.getAttribute('data-meas');
        if (labelName && lastMeas[labelName] !== undefined) {
          inp.value = lastMeas[labelName];
        }
      });

    } else {
      $('#status_text').textContent = "New customer";

      // Clear for new entry
      nameInput && (nameInput.value = '');
      emailInput && (emailInput.value = '');
      building && (building.value = '');
      house && (house.value = '');
      street && (street.value = '');
      area && (area.value = '');
      city && (city.value = '');
      state && (state.value = '');
      zip_code && (zip_code.value = '');
      mobileOver && (mobileOver.value = '');
      mobileInput && (mobileInput.value = mobile);

      const localPrev = document.getElementById('prev_meas_line');
      if (localPrev) {
        localPrev.classList.add('hidden');
        localPrev.textContent = '';
      }
      document.querySelectorAll('input[data-meas]').forEach(inp => inp.value = '');
    }

    // Re-apply thin border classes in case new fields were added dynamically
    styleAllFields(document);
  });
</script>

{% endblock %}
