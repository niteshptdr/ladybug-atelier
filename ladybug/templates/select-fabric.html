{% extends "base.html" %}
{% block content %}


<!-- Modal -->
<div id="productModal"
     class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center px-4 sm:px-6">
  
  <!-- Modal Box -->
  <div class="relative bg-white rounded-2xl p-4 sm:p-6 shadow-xl w-full max-w-md sm:max-w-lg">

    <!-- Close Button (top-right, above modal) -->
    <button id="closeModal"
            class="absolute -top-4 -right-4 bg-white text-gray-600 text-xl p-2 rounded-full shadow-lg hover:bg-rose-200 transition z-50">
      <i class="fas fa-times"></i>
    </button>

    <!-- Image Container -->
    <div id="modalImageContainer" class="relative">

      <!-- Main Image -->
      <img id="modalImage" src="" alt=""
           class="w-full aspect-square object-contain rounded-xl shadow mb-6" />

      <!-- Previous Button -->
      <button id="prevBtn2"
              class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-white text-2xl text-gray-600 p-2 rounded-full shadow hover:bg-pink-100 transition">
        <i class="fas fa-chevron-left"></i>
      </button>

      <!-- Next Button -->
      <button id="nextBtn2"
              class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-white text-2xl text-gray-600 p-2 rounded-full shadow hover:bg-pink-100 transition">
        <i class="fas fa-chevron-right"></i>
      </button>

    </div>

    <!-- Product Detail Link -->
    <div class="text-center mt-4">
      <a id="productDetailLink" href="#"
         class="text-pink-600 underline font-medium text-lg hover:text-pink-800 transition">
        View Product Details
      </a>
    </div>

  </div>
</div>


<div class="max-w-7xl mx-auto py-8 px-4">

      <div class="bg-white border border-pink-200 rounded-xl p-4 shadow-sm mb-6">
      <div>

        <a href="{% url 'select-fabric-option' %}" class="inline-flex items-center text-md text-pink-600 font-medium hover:text-pink-700">
              <i class="fas fa-arrow-left me-2"></i>
                Back
        </a>
      </div>
      </div>

  <h2 class="text-2xl font-bold text-center mb-2">Select Fabric</h2>
  <hr class="mb-6">

  <div class="lg:grid lg:grid-cols-2 lg:gap-4">

  <div>


    <!-- Main Image Carousel -->
    <div id="carousel" class="mb-6 relative">
      <img id="mainImage" src="{{ fabrics.0.images.first.image.url }}" alt="" class="w-full aspect-[15/10] object-cover rounded-xl">
      <button id="prevBtn" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white p-2 rounded-full shadow">❮</button>
      <button id="nextBtn" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white p-2 rounded-full shadow">❯</button>

      <!-- Dot Indicators -->
      <div id="dotContainer" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
        <!-- Dots added by JS -->
      </div>
    </div>
        <!-- Selected Fabric Name -->
    <h3 id="selectedFabricName" class="text-xl font-semibold text-pink-700 ">
      {{ fabrics.0.name }}
    </h3>
    <p id="selectedFabricDescription" class="text-sm text-gray-500 mb-4">{{ fabrics.0.description }}</p>

  </div>

  <div class="">
    <!-- Fabric Thumbnails Scroll -->
    <div class="flex overflow-x-auto space-x-6 pb-4 mb-6 scroll-smooth snap-x">
      {% for fabric in fabrics %}
      <div class="relative flex-shrink-0 text-center w-48 snap-start fabric-item {% if fabric.units_inStock <= 0 %}opacity-50 pointer-events-none{% endif %}"
        data-fabric-id="{{ fabric.id }}">
        <img
          src="{{ fabric.images.first.image.url }}"
          class="fabric-thumbnail aspect-[15/10] object-cover rounded-lg cursor-pointer border-4 border-transparent hover:border-pink-500 mx-auto"
          data-fabric-index="{{ forloop.counter0 }}"
          alt="{{ fabric.name }}">
        <h4 class="mt-2 text-sm font-semibold">{{ fabric.name }}</h4>
        <p class="text-xs text-gray-500">{{ fabric.description|truncatewords:6 }}</p>
                  <div class="">
                      <span class="text-xs font-bold text-gary-800">
                          ₹{{ fabric.price|floatformat:2 }}
                      </span>
                      {% if fabric.original_price %}
                          <span class="text-xs line-through text-gray-500 ml-2">
                              ₹{{ fabric.original_price|floatformat:2 }}
                          </span>
                      {% endif %}

                      <span class="text-xs text-gray-500">/meter</span>
                  </div>

                    <div class="flex items-center justify-center space-x-1 mt-1 shrink-0">
                    {% with rating=fabric.average_rating|default:0 %}
                      {% if rating > 0 %}
                        {% for i in "12345" %}
                          {% with star_num=forloop.counter %}
                            <svg class="w-4 h-4 {% if star_num <= rating %}text-gray-600{% else %}text-gray-300{% endif %}" 
                                fill="currentColor" viewBox="0 0 20 20">
                              <path d="M10 1l2.39 5.99H18l-4.9 4.12 1.82 6.01L10 13.77l-4.92 3.35L6.9 11.1 2 6.99h5.61z" />
                            </svg>
                          {% endwith %}
                        {% endfor %}
                        <span class="text-xs text-gray-600 ml-1">{{ rating|floatformat:1 }}/5</span>
                        <p class="text-xs text-gray-600">({{fabric.total_reviews}})</p>
                      {% else %}
                      <div class="text-xs text-gray-400 italic text-center w-full"> Start the trend – rate it! </div>
                      {% endif %}
                    {% endwith %}
                    </div>
                  
                  <!-- Out of Stock Badge -->
                  {% if fabric.units_inStock <= 0 %}
                  <div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">
                      Out of Stock
                  </div>
                  {% endif %}

      </div>
      {% endfor %}
    </div>

    <div>
      <div id="similar-products-heading"></div>
      
      <div id="similar-products" class="flex overflow-x-auto space-x-6 pb-4 mb-6 scroll-smooth snap-x"></div>
    </div>

  </div>



  </div>
  <!-- Next Button Form -->
  <form id="fabricForm" method="post" action="{% url 'select-fabric' %}" class="text-center mt-6">
    {% csrf_token %}
    <input type="hidden" name="fabric_id" id="selectedFabricId" value="{{ fabrics.0.id }}">
    <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-8 rounded-xl">
      Next  →
    </button>
  </form>

  <!-- JavaScript Section -->
  <script>
    const fabrics = [
      {% for fabric in fabrics %}
      {
        id: {{ fabric.id }},
        name: "{{ fabric.name|escapejs }}",
        description: "{{ fabric.description|truncatewords:20|escapejs }}",
        images: [
          {% for img in fabric.images.all %}
            "{{ img.image.url }}",
          {% endfor %}
        ]
      },
      {% endfor %}
    ];
    
    // Inject from Django context
    const selectedFabricIdFromSession = {{ selected_fabric_id|default:'null' }};

    let currentFabricIndex = 0;

      if (selectedFabricIdFromSession) {
        const foundIndex = fabrics.findIndex(f => f.id === selectedFabricIdFromSession);
        if (foundIndex !== -1) {
          currentFabricIndex = foundIndex;
            }
          }
          
    let currentImageIndex = 0;

    const mainImage = document.getElementById("mainImage");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const dotContainer = document.getElementById("dotContainer");
    const selectedFabricName = document.getElementById("selectedFabricName");
    const selectedFabricDescription = document.getElementById("selectedFabricDescription");
    const selectedFabricIdInput = document.getElementById("selectedFabricId");

    function updateMainImage() {
      const fabric = fabrics[currentFabricIndex];
      mainImage.src = fabric.images[currentImageIndex];
      updateDots();
      selectedFabricName.textContent = fabric.name;
      selectedFabricDescription.textContent = fabric.description;
      selectedFabricIdInput.value = fabric.id;

      highlightSelectedThumbnail();
    }

    function highlightSelectedThumbnail() {
      const thumbnails = document.querySelectorAll(".fabric-thumbnail");
      thumbnails.forEach((thumb, index) => {
        if (index === currentFabricIndex) {
          thumb.classList.add("border-pink-600");
          thumb.classList.remove("border-transparent");
        } else {
          thumb.classList.remove("border-pink-600");
          thumb.classList.add("border-transparent");
        }
      });
    }


        // Swipe Gesture Support
    let touchStartX = 0;
    let touchEndX = 0;

    mainImage.addEventListener("touchstart", (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    mainImage.addEventListener("touchend", (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleGesture();
    });

    function handleGesture() {
      const delta = touchEndX - touchStartX;
      if (Math.abs(delta) > 50) {
        const images = fabrics[currentFabricIndex].images;
        if (delta < 0) {
          // Swipe left → Next
          currentImageIndex = (currentImageIndex + 1) % images.length;
        } else {
          // Swipe right → Previous
          currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        }
        updateMainImage();
      }
    }

    
    function updateDots() {
      const fabric = fabrics[currentFabricIndex];
      dotContainer.innerHTML = "";
      fabric.images.forEach((_, index) => {
        const dot = document.createElement("span");
        dot.className = `h-3 w-3 rounded-full ${index === currentImageIndex ? 'bg-pink-600' : 'bg-gray-300'} inline-block`;
        dotContainer.appendChild(dot);
      });
    }

    prevBtn.addEventListener("click", () => {
      const images = fabrics[currentFabricIndex].images;
      currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
      updateMainImage();
    });

    nextBtn.addEventListener("click", () => {
      const images = fabrics[currentFabricIndex].images;
      currentImageIndex = (currentImageIndex + 1) % images.length;
      updateMainImage();
    });

    document.querySelectorAll("[data-fabric-index]").forEach(thumb => {
      thumb.addEventListener("click", () => {
        currentFabricIndex = parseInt(thumb.dataset.fabricIndex);
        currentImageIndex = 0;
        updateMainImage();
      });
    });

    updateMainImage(); // Initialize on load









let modal = document.getElementById('productModal');
let modalImage = document.getElementById('modalImage');
let productDetailLink = document.getElementById('productDetailLink');
let closeModal = document.getElementById('closeModal');
let nextBtn2 = document.getElementById('nextBtn2');
let prevBtn2 = document.getElementById('prevBtn2');

let currentImageIndex2 = 0;
let currentImages = [];

function openModal(images, productId) {
  currentImages = images;
  currentImageIndex2 = 0;
  modalImage.src = currentImages[0];
  productDetailLink.href = `/${productId}/product-detail`;
  modal.classList.remove('hidden');
}

closeModal.addEventListener('click', () => modal.classList.add('hidden'));

nextBtn2.addEventListener('click', () => {
  currentImageIndex2 = (currentImageIndex2 + 1) % currentImages.length;
  modalImage.src = currentImages[currentImageIndex2];
});

prevBtn2.addEventListener('click', () => {
  currentImageIndex2 = (currentImageIndex2 - 1 + currentImages.length) % currentImages.length;
  modalImage.src = currentImages[currentImageIndex2];
});




    // Get simillar Products 

    // Get all clickable fabric items
const fabricItems = document.querySelectorAll('.fabric-item');

// Where to show similar products
const similarProductsDiv = document.getElementById('similar-products');
const similarProductsHeadingDiv = document.getElementById('similar-products-heading')

fabricItems.forEach(item => {
  item.addEventListener('click', () => {
    const fabricId = item.dataset.fabricId;

    // Optionally highlight selected
    // fabricItems.forEach(el => el.classList.remove('ring-2', 'ring-pink-500'));
    // item.classList.add('ring-2', 'ring-pink-500');

    // Fetch similar products
    fetch(`/get-similar-products/?fabric_id=${fabricId}`)
      .then(response => response.json())
      .then(data => {
        similarProductsDiv.innerHTML = ''; // clear previous results

        if (data.products.length === 0) {
          similarProductsDiv.innerHTML = `
            <p class="text-gray-500">No similar products found.</p>
          `;
          return;
        } else {
          similarProductsHeadingDiv.innerHTML = `
            <h2 class="text-xl font-bold mt-8 mb-4">Crafted with Similar Fabric</h2>
          `;
        }

    data.products.forEach(product => {
      const productCard = document.createElement('div');
      productCard.className = 'bg-white rounded text-center hover:shadow cursor-pointer';

      productCard.innerHTML = `
        <img src="${product.images[0]}" alt="${product.name}" class="w-full h-40 object-cover rounded mb-1">
        <p class="font-medium">${product.name}</p>
      `;

      productCard.addEventListener('click', () => {
        openModal(product.images, product.id);
      });

      similarProductsDiv.appendChild(productCard);
    });
      })
      .catch(error => {
        console.error('Error fetching similar products:', error);
      });
  });
});

  </script>
</div>
{% endblock %}
